<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeedLab Queue System - Multi-Device</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a3a0f, #2d5016, #4a7c23);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: #fff;
            min-height: 100vh;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 20px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #4CAF50;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            color: #fff;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 25px;
            transition: all 0.3s;
            border: 1px solid rgba(76, 175, 80, 0.3);
            position: relative;
            overflow: hidden;
        }

        .nav-links a:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        /* Login Section */
        .login-section {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 50px;
            border-radius: 25px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .login-form {
            max-width: 450px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e8f5e8;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
            transform: translateY(-2px);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: white;
            padding: 15px 35px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(76, 175, 80, 0.6);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Queue Section */
        .queue-section {
            display: none;
        }

        .queue-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
        }

        .stat-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4CAF50, #66BB6A);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #66BB6A);
            border-radius: 4px;
            transition: width 1s ease;
        }

        .queue-list {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border-left: 4px solid #4CAF50;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .queue-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .queue-item.current {
            background: rgba(76, 175, 80, 0.2);
            border-left-color: #FFC107;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .user-tag {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
        }

        .cooldown-timer {
            background: rgba(255, 193, 7, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 193, 7, 0.5);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.2);
        }

        .timer-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #FFC107;
            text-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
            font-family: 'Courier New', monospace;
        }

        /* Server Status */
        .server-status {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .server-status.disconnected {
            background: rgba(244, 67, 54, 0.2);
            border-color: rgba(244, 67, 54, 0.3);
        }

        .server-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.2), transparent);
            animation: serverPulse 3s infinite;
        }

        @keyframes serverPulse {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .server-status.disconnected::before {
            background: linear-gradient(90deg, transparent, rgba(244, 67, 54, 0.2), transparent);
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 35px;
            border-radius: 25px;
            margin-top: 35px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(76, 175, 80, 0.2);
            padding: 25px;
            border-radius: 15px;
            transition: all 0.3s;
        }

        .control-group:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .control-group h3 {
            color: #4CAF50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-list {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4CAF50 rgba(255, 255, 255, 0.1);
        }

        .user-list::-webkit-scrollbar {
            width: 8px;
        }

        .user-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .user-list::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 4px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 3px solid #4CAF50;
            transition: all 0.3s;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .admin-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 20px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #e57373);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 20px rgba(244, 67, 54, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
        }

        .btn-warning:hover {
            box-shadow: 0 4px 20px rgba(255, 152, 0, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #2196F3, #64B5F6);
        }

        .btn-info:hover {
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
        }

        /* Activity Feed */
        .activity-feed {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 14px;
        }

        .activity-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: rgba(76, 175, 80, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.5s ease;
            z-index: 1000;
            border-left: 4px solid #4CAF50;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: rgba(244, 67, 54, 0.9);
            border-left-color: #f44336;
        }

        .notification.warning {
            background: rgba(255, 152, 0, 0.9);
            border-left-color: #ff9800;
        }

        .hidden {
            display: none !important;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* User Highlight */
        .user-highlight {
            border-left-color: #FFC107 !important;
            background: rgba(255, 193, 7, 0.1) !important;
        }
        
        .queue-item .user-info .user-avatar {
            position: relative;
        }
        
        .queue-item.current .user-avatar::after {
            content: 'üëë';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }

            .queue-stats {
                grid-template-columns: 1fr;
            }

            .admin-controls {
                grid-template-columns: 1fr;
            }

            .login-section, .admin-panel {
                padding: 30px 20px;
            }

            .queue-item {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .admin-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üåø</div>
                <div>
                    <h1>WeedLab Queue System</h1>
                    <div class="system-status">
                        <div class="status-dot"></div>
                        <span id="systemStatus">üü¢ System Online</span>
                    </div>
                </div>
            </div>
            <nav class="nav-links">
                <a href="#" id="homeLink" onclick="showQueueSection()">üè° Home</a>
                <a href="#" id="adminLink" class="hidden" onclick="showAdminSection()">‚öôÔ∏è Admin</a>
                <a href="#" id="logoutLink" class="hidden" onclick="logout()">üö™ Exit Lab</a>
            </nav>
        </div>

        <!-- Server Status -->
        <div class="server-status" id="serverStatus">
            <span id="serverStatusText">üåê Connected to Central Lab Server</span>
            <div style="margin-top: 10px;">
                <span>üë• Active Researchers: <span id="onlineCount">0</span></span>
                <span style="margin-left: 20px;">üïí Last Sync: <span id="lastSync">Now</span></span>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>üåø Lab Access Portal</h2>
            <p style="margin: 25px 0; opacity: 0.8;">üõ°Ô∏è Multi-Device Central Authentication System</p>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="username">üë®‚Äçüî¨ Researcher ID</label>
                    <input type="text" id="username" placeholder="Enter your researcher ID">
                </div>
                <div class="form-group">
                    <label for="password">üîê Lab Access Code</label>
                    <input type="password" id="password" placeholder="Enter your access code">
                </div>
                <button class="btn" onclick="login()">
                    <span id="loginText">üöÄ Enter Lab</span>
                    <span id="loginLoader" class="loading hidden"></span>
                </button>
            </div>
        </div>

        <!-- Queue Section -->
        <div id="queueSection" class="queue-section">
            <!-- Cooldown Timer -->
            <div id="cooldownTimer" class="cooldown-timer hidden">
                <h3>‚è≥ Lab Cooldown Active</h3>
                <p>üî¨ Next lab session available in:</p>
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="cooldownProgress"></div>
                </div>
            </div>

            <!-- Queue Stats -->
            <div class="queue-stats">
                <div class="stat-card">
                    <div class="stat-number" id="queuePosition">-</div>
                    <div>üéØ Your Lab Position</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="positionProgress"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalQueue">0</div>
                    <div>üë• Total Researchers</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="totalProgress"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="serverLoad">0%</div>
                    <div>üñ•Ô∏è Server Load</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="loadProgress"></div>
                    </div>
                </div>
            </div>

            <!-- Queue Controls -->
            <div style="text-align: center; margin-bottom: 35px;">
                <button class="btn" id="joinQueueBtn" onclick="joinQueue()">
                    üåø Join Lab Queue
                </button>
                <button class="btn btn-danger" id="leaveQueueBtn" onclick="leaveQueue()" style="display: none;">
                    üö´ Exit Queue
                </button>
                <button class="btn btn-info" onclick="refreshQueue()" style="margin-left: 10px;">
                    üîÑ Refresh Status
                </button>
            </div>

            <!-- Queue List -->
            <div class="queue-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3>üåø Lab Queue Status</h3>
                    <div style="display: flex; gap: 15px;">
                        <span style="color: rgba(255,255,255,0.7); font-size: 14px;">
                            üïí Last Updated: <span id="lastUpdate">Now</span>
                        </span>
                    </div>
                </div>
                <div id="queueList">
                    <!-- Queue items will be populated here -->
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="activity-feed">
                <h3>üìà Lab Activity Monitor</h3>
                <div id="activityList">
                    <!-- Activity items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel">
            <h2>üåø Lab Administrator Panel</h2>
            <div class="admin-controls">
                <div class="control-group">
                    <h3>üåø Researcher Management</h3>
                    <div class="form-group">
                        <label for="newUsername">üÜî Researcher ID</label>
                        <input type="text" id="newUsername" placeholder="Enter researcher ID">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">üîê Access Code</label>
                        <input type="password" id="newPassword" placeholder="Enter access code">
                    </div>
                    <div class="form-group">
                        <label for="userRole">üë§ Lab Role</label>
                        <select id="userRole">
                            <option value="user">üåø Research Assistant</option>
                            <option value="admin">üåø Lab Director</option>
                        </select>
                    </div>
                    <button class="btn" onclick="createUser()">‚ûï Add Researcher</button>
                </div>

                <div class="control-group">
                    <h3>üéõÔ∏è Lab Queue Control</h3>
                    <div style="display: grid; gap: 15px;">
                        <button class="btn btn-warning" onclick="pauseQueue()">‚è∏Ô∏è Pause Lab Queue</button>
                        <button class="btn btn-info" onclick="resumeQueue()">‚ñ∂Ô∏è Resume Operations</button>
                        <button class="btn btn-danger" onclick="clearQueue()">üßπ Clear All Queue</button>
                        <button class="btn" onclick="processNext()">‚è≠Ô∏è Process Next Researcher</button>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üîß Server Management</h3>
                    <div style="display: grid; gap: 15px;">
                        <button class="btn btn-info" onclick="syncData()">üîÑ Force Sync</button>
                        <button class="btn btn-warning" onclick="resetServer()">üîÑ Reset Server</button>
                        <button class="btn" onclick="exportData()">üì• Export Data</button>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="user-management">
                <h3>üë• Registered Researchers</h3>
                <div class="user-list" id="userList">
                    <!-- User items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        // Central Server Simulation System
        class CentralServer {
            constructor() {
                this.serverId = 'weedlab_central_' + Date.now();
                this.lastSync = Date.now();
                this.syncInterval = 5000; // 5 seconds
                this.isOnline = navigator.onLine;
                
                this.initializeServer();
                this.setupEventListeners();
                this.startSyncProcess();
            }

            initializeServer() {
                // Default server data
                this.serverData = {
                    queue: [],
                    users: [
                        { username: 'admin', password: 'admin123', role: 'admin', created: new Date().toISOString() }
                    ],
                    cooldownUsers: {},
                    firstPositionTimer: null,
                    queuePaused: false,
                    activity: [],
                    userLogs: {},
                    activeSessions: {},
                    serverStats: {
                        totalUsers: 1,
                        activeUsers: 0,
                        queueOperations: 0,
                        uptime: Date.now()
                    },
                    lastUpdate: Date.now(),
                    version: '2.0'
                };

                // Try to load data from local backup
                const backupData = this.getLocalBackup();
                if (backupData && backupData.version === '2.0') {
                    this.serverData = { ...this.serverData, ...backupData };
                }
            }

            // Local Backup System
            getLocalBackup() {
                try {
                    const backup = localStorage.getItem('weedlab_backup');
                    return backup ? JSON.parse(backup) : null;
                } catch (e) {
                    console.warn('Failed to load local backup:', e);
                    return null;
                }
            }

            saveLocalBackup() {
                try {
                    localStorage.setItem('weedlab_backup', JSON.stringify(this.serverData));
                } catch (e) {
                    console.warn('Failed to save local backup:', e);
                }
            }

            // Server Communication Simulation
            async syncWithServer() {
                try {
                    // Simulate network delay
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000));
                    
                    // Simulate success/failure
                    if (Math.random() < 0.95) { // 95% success rate
                        this.isOnline = true;
                        this.lastSync = Date.now();
                        this.saveLocalBackup();
                        this.updateServerStatus(true);
                        return { success: true, data: this.serverData };
                    } else {
                        throw new Error('Network timeout');
                    }
                } catch (error) {
                    this.isOnline = false;
                    this.updateServerStatus(false);
                    console.warn('Server sync failed:', error.message);
                    return { success: false, error: error.message };
                }
            }

            updateServerStatus(online) {
                const statusElement = document.getElementById('serverStatus');
                const statusText = document.getElementById('serverStatusText');
                const lastSyncElement = document.getElementById('lastSync');
                
                if (online) {
                    statusElement.classList.remove('disconnected');
                    statusText.textContent = 'üåê Connected to Central Lab Server';
                    lastSyncElement.textContent = new Date(this.lastSync).toLocaleTimeString();
                } else {
                    statusElement.classList.add('disconnected');
                    statusText.textContent = 'üî¥ Connection Lost - Using Local Cache';
                    lastSyncElement.textContent = 'Offline';
                }
            }

            setupEventListeners() {
                // Monitor connection status
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.syncWithServer();
                    showNotification('üì° Connection restored - Syncing...', 'success');
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateServerStatus(false);
                    showNotification('üî¥ Connection lost - Working offline', 'warning');
                });

                // Monitor window close
                window.addEventListener('beforeunload', () => {
                    this.removeSession();
                });
            }

            startSyncProcess() {
                // Periodic sync
                setInterval(async () => {
                    if (this.isOnline) {
                        await this.syncWithServer();
                        this.updateActiveSessionsCount();
                    }
                }, this.syncInterval);

                // Real-time sync with broadcast channel
                this.broadcastChannel = new BroadcastChannel('weedlab_sync');
                this.broadcastChannel.onmessage = (event) => {
                    if (event.data.type === 'data_update') {
                        this.serverData = event.data.data;
                        this.updateDisplay();
                    }
                };
            }

            // Data Management
            updateData(updateFunction) {
                this.serverData = updateFunction(this.serverData);
                this.serverData.lastUpdate = Date.now();
                
                // Send update to other tabs
                this.broadcastChannel.postMessage({
                    type: 'data_update',
                    data: this.serverData,
                    timestamp: Date.now()
                });

                // Sync with server
                this.syncWithServer();
                
                return this.serverData;
            }

            getData() {
                return this.serverData;
            }

            // Session Management
            addSession(username) {
                const sessionId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                this.serverData.activeSessions[sessionId] = {
                    username: username,
                    timestamp: Date.now(),
                    lastSeen: Date.now(),
                    userAgent: navigator.userAgent.substring(0, 100),
                    ip: 'simulated_' + Math.random().toString(36).substr(2, 8)
                };
                
                this.updateData(data => data);
                return sessionId;
            }

            removeSession() {
                if (currentSessionId && this.serverData.activeSessions[currentSessionId]) {
                    delete this.serverData.activeSessions[currentSessionId];
                    this.updateData(data => data);
                }
            }

            updateSession() {
                if (currentSessionId && this.serverData.activeSessions[currentSessionId]) {
                    this.serverData.activeSessions[currentSessionId].lastSeen = Date.now();
                }
            }

            updateActiveSessionsCount() {
                const now = Date.now();
                const activeTimeout = 30000; // 30 seconds

                // Clean expired sessions
                Object.keys(this.serverData.activeSessions).forEach(sessionId => {
                    const session = this.serverData.activeSessions[sessionId];
                    if (now - session.lastSeen > activeTimeout) {
                        delete this.serverData.activeSessions[sessionId];
                    }
                });

                const activeCount = Object.keys(this.serverData.activeSessions).length;
                this.serverData.serverStats.activeUsers = activeCount;
                
                const onlineCountElement = document.getElementById('onlineCount');
                if (onlineCountElement) {
                    onlineCountElement.textContent = activeCount;
                }
            }

            // Server Load Simulation
            getServerLoad() {
                const baseLoad = Math.min(this.serverData.queue.length * 5, 50);
                const randomFluctuation = Math.random() * 20;
                return Math.min(Math.round(baseLoad + randomFluctuation), 100);
            }
        }

        // Global Variables
        let currentUser = null;
        let currentSessionId = null;
        let centralServer = null;
        let settings = {
            maxQueueSize: 50,
            serviceTime: 5,
            cooldownTime: 12 * 60, // 12 hours in minutes
            firstPositionTime: 5 * 60 // 5 hours in minutes
        };

        // Initialize System
        document.addEventListener('DOMContentLoaded', function() {
            centralServer = new CentralServer();
            
            // Periodic display updates
            setInterval(() => {
                if (currentUser) {
                    updateDisplay();
                    centralServer.updateSession();
                }
            }, 2000);

            // Timer updates
            setInterval(updateCooldowns, 1000);
            setInterval(checkFirstPositionTimer, 1000);
            
            // Support Enter key for login
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });

            // Initial display
            updateDisplay();
        });

        // Authentication Functions
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showNotification('üö® Please enter both researcher ID and access code', 'error');
                return;
            }

            // Show loading
            document.getElementById('loginText').style.display = 'none';
            document.getElementById('loginLoader').classList.remove('hidden');
            document.querySelector('.btn').disabled = true;

            try {
                // Simulate server verification
                const syncResult = await centralServer.syncWithServer();
                
                if (!syncResult.success && !centralServer.isOnline) {
                    showNotification('üî¥ Cannot connect to server - Using cached data', 'warning');
                }

                const data = centralServer.getData();
                const user = data.users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    currentUser = user;
                    currentSessionId = centralServer.addSession(username);
                    
                    // Log activity
                    centralServer.updateData(data => {
                        data.activity.push({
                            text: `üî¨ ${user.username} entered the lab from ${getDeviceInfo()}`,
                            time: new Date().toLocaleTimeString(),
                            timestamp: new Date().toISOString(),
                            deviceInfo: getDeviceInfo()
                        });
                        
                        // Keep last 100 activities
                        if (data.activity.length > 100) {
                            data.activity = data.activity.slice(-100);
                        }
                        
                        return data;
                    });
                    
                    showNotification(`üéâ Welcome to WeedLab, ${user.username}!`, 'success');
                    showQueueSection();
                } else {
                    showNotification('üîí Invalid lab credentials', 'error');
                }
            } catch (error) {
                showNotification('üî¥ Login failed - Server error', 'error');
                console.error('Login error:', error);
            } finally {
                // Hide loading
                document.getElementById('loginText').style.display = 'inline';
                document.getElementById('loginLoader').classList.add('hidden');
                document.querySelector('.btn').disabled = false;
            }
        }

        function logout() {
            if (currentUser) {
                centralServer.updateData(data => {
                    data.activity.push({
                        text: `üö™ ${currentUser.username} exited the lab`,
                        time: new Date().toLocaleTimeString(),
                        timestamp: new Date().toISOString()
                    });
                    return data;
                });
                
                centralServer.removeSession();
            }
            
            currentUser = null;
            currentSessionId = null;
            
            // Reset interface
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('queueSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('logoutLink').classList.add('hidden');
            document.getElementById('adminLink').classList.add('hidden');
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            updateDisplay();
        }

        // Navigation Functions
        function showQueueSection() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('queueSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('logoutLink').classList.remove('hidden');
            
            if (currentUser && currentUser.role === 'admin') {
                document.getElementById('adminLink').classList.remove('hidden');
            }
            
            updateDisplay();
        }

        function showAdminSection() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            document.getElementById('queueSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            updateDisplay();
        }

        // Queue Management Functions
        function joinQueue() {
            if (!currentUser) return;
            
            const data = centralServer.getData();
            
            // Check restrictions
            if (data.cooldownUsers[currentUser.username] && new Date() < new Date(data.cooldownUsers[currentUser.username])) {
                const remainingTime = Math.ceil((new Date(data.cooldownUsers[currentUser.username]) - new Date()) / (1000 * 60));
                showNotification(`‚è≥ Lab cooldown active for ${remainingTime} more minutes`, 'warning');
                return;
            }
            
            if (data.queue.length >= settings.maxQueueSize) {
                showNotification('üö´ Lab queue is at maximum capacity', 'error');
                return;
            }
            
            if (data.queue.find(u => u.username === currentUser.username)) {
                showNotification('‚ö†Ô∏è You are already in the lab queue', 'warning');
                return;
            }
            
            if (data.queuePaused) {
                showNotification('‚è∏Ô∏è Lab queue is currently paused', 'warning');
                return;
            }
            
            // Join queue
            centralServer.updateData(data => {
                const queueUser = {
                    username: currentUser.username,
                    joinTime: new Date().toISOString(),
                    position: data.queue.length + 1,
                    deviceInfo: getDeviceInfo()
                };
                
                data.queue.push(queueUser);
                data.serverStats.queueOperations++;
                
                // Log activity
                data.activity.push({
                    text: `üåø ${currentUser.username} joined lab queue (Position: ${data.queue.length}) from ${getDeviceInfo()}`,
                    time: new Date().toLocaleTimeString(),
                    timestamp: new Date().toISOString()
                });
                
                // Setup first position timer
                if (data.queue.length === 1) {
                    data.firstPositionTimer = {
                        username: currentUser.username,
                        startTime: new Date().toISOString(),
                        endTime: new Date(Date.now() + settings.firstPositionTime * 60 * 1000).toISOString()
                    };
                    
                    data.activity.push({
                        text: `ü•á ${currentUser.username} reached position #1 - 5 hour lab timer started`,
                        time: new Date().toLocaleTimeString(),
                        timestamp: new Date().toISOString()
                    });
                }
                
                return data;
            });
            
            showNotification('üéØ Successfully joined the lab queue!', 'success');
            updateDisplay();
        }

        function leaveQueue() {
            if (!currentUser) return;
            
            centralServer.updateData(data => {
                const userIndex = data.queue.findIndex(u => u.username === currentUser.username);
                if (userIndex === -1) {
                    showNotification('‚ùå You are not in the lab queue', 'warning');
                    return data;
                }
                
                const wasFirst = userIndex === 0;
                data.queue.splice(userIndex, 1);
                
                // Log activity
                data.activity.push({
                    text: `üö´ ${currentUser.username} left the lab queue`,
                    time: new Date().toLocaleTimeString(),
                    timestamp: new Date().toISOString()
                });
                
                // Start cooldown
                data.cooldownUsers[currentUser.username] = new Date(Date.now() + settings.cooldownTime * 60 * 1000).toISOString();
                
                // Update first position timer
                if (wasFirst) {
                    if (data.queue.length > 0) {
                        data.firstPositionTimer = {
                            username: data.queue[0].username,
                            startTime: new Date().toISOString(),
                            endTime: new Date(Date.now() + settings.firstPositionTime * 60 * 1000).toISOString()
                        };
                        
                        data.activity.push({
                            text: `ü•á ${data.queue[0].username} reached position #1 - 5 hour lab timer started`,
                            time: new Date().toLocaleTimeString(),
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        data.firstPositionTimer = null;
                    }
                }
                
                return data;
            });
            
            showNotification('üì§ Exited the lab queue', 'info');
            updateDisplay();
        }

        function refreshQueue() {
            centralServer.syncWithServer();
            updateDisplay();
            showNotification('üîÑ Lab queue status refreshed', 'info');
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Admin Functions
        function createUser() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('userRole').value;
            
            if (!username || !password) {
                showNotification('üìù Please fill all researcher details', 'error');
                return;
            }
            
            centralServer.updateData(data => {
                if (data.users.find(u => u.username === username)) {
                    showNotification('üîÑ Researcher ID already exists', 'error');
                    return data;
                }
                
                data.users.push({ 
                    username, 
                    password, 
                    role,
                    created: new Date().toISOString(),
                    createdBy: currentUser.username
                });
                
                data.serverStats.totalUsers++;
                
                data.activity.push({
                    text: `‚ûï Lab Director added researcher: ${username} (${role})`,
                    time: new Date().toLocaleTimeString(),
                    timestamp: new Date().toISOString()
                });
                
                return data;
            });
            
            showNotification(`‚ú® Researcher ${username} added successfully`, 'success');
            
            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            
            updateDisplay();
        }

        function deleteUser(username) {
            if (!currentUser || currentUser.role !== 'admin') return;
            if (username === 'admin') {
                showNotification('üõ°Ô∏è Cannot delete lab director account', 'error');
                return;
            }
            
            centralServer.updateData(data => {
                data.users = data.users.filter(u => u.username !== username);
                data.queue = data.queue.filter(u => u.username !== username);
                delete data.cooldownUsers[username];
                
                // Remove active sessions
                Object.keys(data.activeSessions).forEach(sessionId => {
                    if (data.activeSessions[sessionId].username === username) {
                        delete data.activeSessions[sessionId];
                    }
                });
                
                data.activity.push({
                    text: `üóëÔ∏è Lab Director removed researcher: ${username}`,
                    time: new Date().toLocaleTimeString(),
                    timestamp: new Date().toISOString()
                });
                
                return data;
            });
            
            showNotification(`‚ùå Researcher ${username} removed from lab`, 'success');
            updateDisplay();
        }

        function removeFromQueue(username) {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            centralServer.updateData(data => {
                const userIndex = data.queue.findIndex(u => u.username === username);
                if (userIndex !== -1) {
                    const wasFirst = userIndex === 0;
                    data.queue.splice(userIndex, 1);
                    
                    data.activity.push({
                        text: `‚öóÔ∏è Lab Director removed ${username} from queue`,
                        time: new Date().toLocaleTimeString(),
                        timestamp: new Date().toISOString()
                    });
                    
                    // Update first position timer
                    if (wasFirst) {
                        if (data.queue.length > 0) {
                            data.firstPositionTimer = {
                                username: data.queue[0].username,
                                startTime: new Date().toISOString(),
                                endTime: new Date(Date.now() + settings.firstPositionTime * 60 * 1000).toISOString()
                            };
                        } else {
                            data.firstPositionTimer = null;
                        }
                    }
                }
                
                return data;
            });
            
            showNotification(`üö´ Removed ${username} from lab queue`, 'success');
            updateDisplay();
        }

        function pauseQueue() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            centralServer.updateData(data => {
                data.queuePaused = true;
                data.activity.push({
                    text: '‚è∏Ô∏è Lab Director paused the queue',
                    time: new Date().toLocaleTimeString(),
                    timestamp: new Date().toISOString()
                });
                return data;
            });
            
            showNotification('‚è∏Ô∏è Lab queue paused', 'warning');
        }

        function resumeQueue() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            centralServer.updateData(data => {
                data.queuePaused = false;
                data.activity.push({
                    text: '‚ñ∂Ô∏è Lab Director resumed operations',
                    time: new Date().toLocaleTimeString(),
                    timestamp: new Date().toISOString()
                });
                return data;
            });
            
            showNotification('‚ñ∂Ô∏è Lab queue resumed', 'success');
        }

        function clearQueue() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            if (confirm('‚ö†Ô∏è Are you sure you want to clear the entire lab queue?')) {
                centralServer.updateData(data => {
                    data.queue = [];
                    data.firstPositionTimer = null;
                    
                    data.activity.push({
                        text: 'üßπ Lab Director cleared the entire queue',
                        time: new Date().toLocaleTimeString(),
                        timestamp: new Date().toISOString()
                    });
                    
                    return data;
                });
                
                showNotification('üóëÔ∏è Lab queue cleared', 'success');
                updateDisplay();
            }
        }

        function processNext() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            centralServer.updateData(data => {
                if (data.queue.length === 0) {
                    showNotification('üì≠ Lab queue is empty', 'warning');
                    return data;
                }
                
                const processedUser = data.queue.shift();
                
                data.activity.push({
                    text: `‚úÖ ${processedUser.username} completed lab session`,
                    time: new Date().toLocaleTimeString(),
                    timestamp: new Date().toISOString()
                });
                
                // Start cooldown for processed user
                data.cooldownUsers[processedUser.username] = new Date(Date.now() + settings.cooldownTime * 60 * 1000).toISOString();
                
                // Check for new first position user
                if (data.queue.length > 0) {
                    data.firstPositionTimer = {
                        username: data.queue[0].username,
                        startTime: new Date().toISOString(),
                        endTime: new Date(Date.now() + settings.firstPositionTime * 60 * 1000).toISOString()
                    };
                    
                    data.activity.push({
                        text: `ü•á ${data.queue[0].username} reached position #1 - 5 hour lab timer started`,
                        time: new Date().toLocaleTimeString(),
                        timestamp: new Date().toISOString()
                    });
                } else {
                    data.firstPositionTimer = null;
                }
                
                data.serverStats.queueOperations++;
                return data;
            });
            
            showNotification(`üéØ Processed next researcher`, 'success');
            updateDisplay();
        }

        // Server Management Functions
        function syncData() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            centralServer.syncWithServer().then(result => {
                if (result.success) {
                    showNotification('üîÑ Data synchronized successfully', 'success');
                } else {
                    showNotification('üî¥ Sync failed - Check connection', 'error');
                }
                updateDisplay();
            });
        }

        function resetServer() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            if (confirm('‚ö†Ô∏è This will reset all server data. Are you sure?')) {
                centralServer.serverData = {
                    queue: [],
                    users: [
                        { username: 'admin', password: 'admin123', role: 'admin', created: new Date().toISOString() }
                    ],
                    cooldownUsers: {},
                    firstPositionTimer: null,
                    queuePaused: false,
                    activity: [{
                        text: 'üîÑ Server reset by Lab Director',
                        time: new Date().toLocaleTimeString(),
                        timestamp: new Date().toISOString()
                    }],
                    userLogs: {},
                    activeSessions: {},
                    serverStats: {
                        totalUsers: 1,
                        activeUsers: 0,
                        queueOperations: 0,
                        uptime: Date.now()
                    },
                    lastUpdate: Date.now(),
                    version: '2.0'
                };
                
                centralServer.syncWithServer();
                showNotification('üîÑ Server reset successfully', 'success');
                updateDisplay();
            }
        }

        function exportData() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const data = centralServer.getData();
            const exportData = {
                exportDate: new Date().toISOString(),
                serverData: data,
                exportedBy: currentUser.username
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `weedlab_export_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('üì• Data exported successfully', 'success');
        }

        function clearAllData() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            if (confirm('üö® This will permanently delete ALL data. This cannot be undone!')) {
                if (confirm('üö® Final confirmation: Delete everything?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        // Timer Functions
        function checkFirstPositionTimer() {
            const data = centralServer.getData();
            if (!data || !data.firstPositionTimer || data.queue.length === 0) return;
            
            const now = new Date();
            const endTime = new Date(data.firstPositionTimer.endTime);
            
            if (now >= endTime) {
                const expiredUser = data.queue[0];
                if (expiredUser && expiredUser.username === data.firstPositionTimer.username) {
                    centralServer.updateData(data => {
                        data.queue.shift();
                        
                        // Add to cooldown
                        data.cooldownUsers[expiredUser.username] = new Date(Date.now() + settings.cooldownTime * 60 * 1000).toISOString();
                        
                        data.activity.push({
                            text: `‚è∞ ${expiredUser.username} removed from queue (5-hour lab timer expired)`,
                            time: new Date().toLocaleTimeString(),
                            timestamp: new Date().toISOString()
                        });
                        
                        // Reset timer for new user
                        if (data.queue.length > 0) {
                            data.firstPositionTimer = {
                                username: data.queue[0].username,
                                startTime: new Date().toISOString(),
                                endTime: new Date(Date.now() + settings.firstPositionTime * 60 * 1000).toISOString()
                            };
                            
                            data.activity.push({
                                text: `ü•á ${data.queue[0].username} reached position #1 - 5 hour lab timer started`,
                                time: new Date().toLocaleTimeString(),
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            data.firstPositionTimer = null;
                        }
                        
                        return data;
                    });
                    
                    // Notify if current user
                    if (currentUser && currentUser.username === expiredUser.username) {
                        showNotification('‚è∞ Your 5-hour lab timer expired! You have been removed from the queue.', 'error');
                    }
                    
                    updateDisplay();
                }
            }
        }

        // Display Update Functions
        function updateDisplay() {
            const data = centralServer.getData();
            if (!data) return;
            
            updateQueueStats(data);
            updateQueueList(data);
            updateActivityFeed(data);
            updateCooldownTimer(data);
            updateServerLoad();
            
            if (currentUser && currentUser.role === 'admin') {
                updateUserList(data);
            }
        }

        function updateQueueStats(data) {
            const userPosition = currentUser ? data.queue.findIndex(u => u.username === currentUser.username) + 1 : 0;
            const totalQueue = data.queue.length;
            
            document.getElementById('queuePosition').textContent = userPosition || '-';
            document.getElementById('totalQueue').textContent = totalQueue;
            
            // Update progress bars
            const maxQueue = settings.maxQueueSize;
            document.getElementById('positionProgress').style.width = userPosition ? `${(userPosition / maxQueue) * 100}%` : '0%';
            document.getElementById('totalProgress').style.width = `${(totalQueue / maxQueue) * 100}%`;
            
            // Update join/leave buttons
            const inQueue = currentUser && data.queue.find(u => u.username === currentUser.username);
            document.getElementById('joinQueueBtn').style.display = inQueue ? 'none' : 'inline-block';
            document.getElementById('leaveQueueBtn').style.display = inQueue ? 'inline-block' : 'none';
        }

        function updateQueueList(data) {
            const queueList = document.getElementById('queueList');
            if (!queueList) return;
            
            if (data.queue.length === 0) {
                queueList.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 30px;">üåø Lab queue is empty - Ready for researchers!</p>';
                return;
            }
            
            queueList.innerHTML = data.queue.map((user, index) => {
                const isCurrentUser = currentUser && user.username === currentUser.username;
                const waitTime = Math.floor((new Date() - new Date(user.joinTime)) / 1000 / 60);
                const isFirst = index === 0;
                
                // Calculate first position timer if exists
                let timerDisplay = '';
                if (isFirst && data.firstPositionTimer && data.firstPositionTimer.username === user.username) {
                    const remaining = new Date(data.firstPositionTimer.endTime) - new Date();
                    if (remaining > 0) {
                        const hours = Math.floor(remaining / (1000 * 60 * 60));
                        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                        timerDisplay = `
                            <div style="color: #FFC107; font-weight: bold; margin-top: 5px;">
                                ‚è∞ Lab time remaining: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}
                            </div>
                        `;
                    }
                }
                
                return `
                    <div class="queue-item ${isFirst ? 'current' : ''} ${isCurrentUser ? 'user-highlight' : ''}">
                        <div class="user-info">
                            <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                            <div>
                                <div style="font-weight: 600;">
                                    üåø ${user.username} ${isCurrentUser ? '(You)' : ''}
                                    ${isFirst ? 'üèÜ' : ''}
                                </div>
                                <div style="font-size: 14px; opacity: 0.8;">
                                    ‚è±Ô∏è Waiting: ${waitTime} min | üì± ${user.deviceInfo || 'Unknown Device'}
                                </div>
                                ${timerDisplay}
                            </div>
                        </div>
                        <div>
                            <div class="user-tag">#${index + 1}</div>
                            ${currentUser && currentUser.role === 'admin' ? `
                                <div style="display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-small btn-danger" onclick="removeFromQueue('${user.username}')" style="font-size: 12px;">
                                        üö´ Remove
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateUserList(data) {
            const userList = document.getElementById('userList');
            if (!userList || !currentUser || currentUser.role !== 'admin') return;
            
            userList.innerHTML = data.users.map(user => {
                const inQueue = data.queue.find(q => q.username === user.username);
                const inCooldown = data.cooldownUsers[user.username] && new Date() < new Date(data.cooldownUsers[user.username]);
                const hasActiveSession = Object.values(data.activeSessions).find(s => s.username === user.username);
                
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                            <div>
                                <div style="font-weight: 600;">üåø ${user.username}</div>
                                <div style="font-size: 14px; opacity: 0.8;">
                                    üë§ Role: ${user.role === 'admin' ? 'üåø Lab Director' : 'üåø Research Assistant'}
                                    ${inQueue ? ' | üìç In Queue' : ''}
                                    ${inCooldown ? ' | ‚è≥ On Cooldown' : ''}
                                    ${hasActiveSession ? ' | üü¢ Online' : ' | üî¥ Offline'}
                                </div>
                                ${hasActiveSession ? `
                                    <div style="font-size: 12px; opacity: 0.6;">
                                        üì± ${hasActiveSession.userAgent.split(' ')[0]} | üåê ${hasActiveSession.ip}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="admin-actions">
                            ${user.username !== 'admin' ? `
                                <button class="btn btn-small btn-danger" onclick="deleteUser('${user.username}')">
                                    üóëÔ∏è Delete
                                </button>
                            ` : ''}
                            ${inQueue ? `
                                <button class="btn btn-small btn-warning" onclick="removeFromQueue('${user.username}')">
                                    üö´ Remove from Queue
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateActivityFeed(data) {
            const activityList = document.getElementById('activityList');
            if (!activityList) return;
            
            const recentActivity = data.activity.slice(-15).reverse();
            
            if (recentActivity.length === 0) {
                activityList.innerHTML = '<p style="text-align: center; opacity: 0.7;">üåø No recent lab activity</p>';
                return;
            }
            
            activityList.innerHTML = recentActivity.map(item => `
                <div class="activity-item">
                    <span>üìã</span>
                    <span>${item.text}</span>
                    <span class="activity-time">üïí ${item.time}</span>
                </div>
            `).join('');
        }

        function updateCooldownTimer(data) {
            const cooldownTimer = document.getElementById('cooldownTimer');
            if (!cooldownTimer || !currentUser) return;
            
            const cooldownEnd = data.cooldownUsers[currentUser.username];
            if (cooldownEnd && new Date() < new Date(cooldownEnd)) {
                const remaining = new Date(cooldownEnd) - new Date();
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                cooldownTimer.classList.remove('hidden');
                document.getElementById('timerDisplay').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const totalCooldown = settings.cooldownTime * 60 * 1000;
                const elapsed = totalCooldown - remaining;
                const progress = (elapsed / totalCooldown) * 100;
                document.getElementById('cooldownProgress').style.width = `${progress}%`;
            } else {
                cooldownTimer.classList.add('hidden');
            }
        }

        function updateServerLoad() {
            const loadElement = document.getElementById('serverLoad');
            const loadProgress = document.getElementById('loadProgress');
            
            if (loadElement && loadProgress && centralServer) {
                const load = centralServer.getServerLoad();
                loadElement.textContent = `${load}%`;
                loadProgress.style.width = `${load}%`;
                
                // Change color based on load
                if (load < 30) {
                    loadProgress.style.background = 'linear-gradient(90deg, #4CAF50, #66BB6A)';
                } else if (load < 70) {
                    loadProgress.style.background = 'linear-gradient(90deg, #FFC107, #FFD54F)';
                } else {
                    loadProgress.style.background = 'linear-gradient(90deg, #f44336, #e57373)';
                }
            }
        }

        function updateCooldowns() {
            if (currentUser) {
                const data = centralServer.getData();
                if (data) {
                    updateCooldownTimer(data);
                }
            }
        }

        // Utility Functions
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let device = 'Unknown Device';
            
            if (/Mobile|Android|iPhone|iPad/.test(ua)) {
                if (/iPhone/.test(ua)) device = 'iPhone';
                else if (/iPad/.test(ua)) device = 'iPad';
                else if (/Android/.test(ua)) device = 'Android';
                else device = 'Mobile';
            } else {
                if (/Windows/.test(ua)) device = 'Windows PC';
                else if (/Mac/.test(ua)) device = 'Mac';
                else if (/Linux/.test(ua)) device = 'Linux';
                else device = 'Desktop';
            }
            
            const browser = getBrowserInfo();
            return `${device} (${browser})`;
        }

        function getBrowserInfo() {
            const ua = navigator.userAgent;
            if (/Chrome/.test(ua) && !/Edge/.test(ua)) return 'Chrome';
            if (/Firefox/.test(ua)) return 'Firefox';
            if (/Safari/.test(ua) && !/Chrome/.test(ua)) return 'Safari';
            if (/Edge/.test(ua)) return 'Edge';
            return 'Unknown';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Debug Functions (for developers)
        function debugInfo() {
            if (currentUser && currentUser.role === 'admin') {
                const data = centralServer.getData();
                console.log('=== WeedLab Debug Info ===');
                console.log('Current User:', currentUser);
                console.log('Session ID:', currentSessionId);
                console.log('Server Online:', centralServer.isOnline);
                console.log('Queue Length:', data.queue.length);
                console.log('Active Sessions:', Object.keys(data.activeSessions).length);
                console.log('Total Users:', data.users.length);
                console.log('Server Load:', centralServer.getServerLoad() + '%');
                console.log('Last Sync:', new Date(centralServer.lastSync));
                console.log('=========================');
            }
        }

        // Add debug functions to console
        window.weedlab = {
            debug: debugInfo,
            getData: () => centralServer.getData(),
            getServer: () => centralServer,
            getCurrentUser: () => currentUser,
            forceSync: () => centralServer.syncWithServer()
        };

        // Cleanup on page close
        window.addEventListener('beforeunload', function() {
            if (centralServer && currentUser) {
                centralServer.removeSession();
            }
        });
    </script>
</body>
</html>
